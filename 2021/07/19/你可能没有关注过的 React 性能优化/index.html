<!doctype html>
<html>
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>青湛</title>
  <meta name="author" content="青湛" />
  <meta name="keywords" content="青湛,博客,qingzhan,mintsweet,blog" />
  <meta name="description" content="青湛's Blog" />
  
  <link rel="icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.tailwindcss.com"></script>
<meta name="generator" content="Hexo 6.3.0"></head>

  <body class="relative pb-8 min-h-screen border-t-2 border-black">
    <header class="shadow-sm bg-white">
  <div class="flex justify-between mx-auto max-w-3xl py-2">
    <div class="flex items-center">
      <div class="w-8 h-8">
        <img src="/logo.svg" alt="" />
      </div>
      <h1 class="ml-4">青湛</h1>
    </div>
    <ul class="flex items-center justify-end">
      
      <li class="ml-4"><a href="/" title="Home">Home</a></li>
      
      <li class="ml-4"><a href="/about/" title="About">About</a></li>
      
      <li class="ml-4"><a href="/archives/" title="Archives">Archives</a></li>
      
      <li class="ml-4"><a href="/tags/" title="Tags">Tags</a></li>
      
    </ul>
  </div>
</header>

    <main>
      <div class="mx-auto max-w-3xl"><div class="py-8 post">
  <h1 class="text-3xl font-semibold mb-1">你可能没有关注过的 React 性能优化</h1>
  <div class="flex items-center mb-4 text-sm">
    <span class="pl-2 text-slate-400">2021-07-19</span>
    <span class="mx-4">|</span>
    
    <div class="flex items-center">
       <a href="/tags/%E6%8A%80%E6%9C%AF/" title="#技术" class="mr-2 text-slate-400">#技术</a>  <a href="/tags/React/" title="#React" class="mr-2 text-slate-400">#React</a> 
    </div>
    
  </div>
  <article class="post-content"><blockquote>
<p>说来我也有很久没有更新过分享了，也一直处在温水煮青蛙的状态。因为一些原因加上这个社会真的太卷了，所以我也被迫加入了内卷大军，重温了很多知识，同时确实也发现了自己很多不足，也想借此机会让大家卷起来，毕竟能力是自己。</p>
</blockquote>
<h2 id="先说两句"><a href="#先说两句" class="headerlink" title="先说两句"></a>先说两句</h2><p>关于我今天想写的内容，大部分你其实都可以在<code>React</code>官方文档上学习到。那为什么我还是想写？因为作为一个写了差不多有三年的<code>React</code>的人，我居然没有正儿八经的通读过官方文档，我想告诉的可能是和我类似的人吧，同时也补充一些我自己的理解和看法。</p>
<span id="more"></span>

<h2 id="问你几个问题"><a href="#问你几个问题" class="headerlink" title="问你几个问题"></a>问你几个问题</h2><p>性能优化这个问题啊，真的是永远都逃不了，是个面试官都要问几句，不过说实话不知道是<code>React</code>做的太好了，还是我做的项目都太基础了，基本没遇到过什么性能问题，导致我在很长一段时间内根本不知道 React 还有很多跟性能优化有关的 API。</p>
<p>先来看个代码，我直接在一个文件里定义多个组件方便大家观看，正式编写代码的时候一个文件就是一个组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Test componentDidUpdate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleTestClick</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Test</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleTestClick&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这代码没什么好说的，每次点击<code>click</code>更新<code>state</code>，我现在问几个问题，你先思考一下~</p>
<ol>
<li>每次点击<code>click</code>的时候，<code>Test</code>组件会打印<code>Test componentDidUpdate</code>吗？</li>
<li>如果我把<code>Test</code>组件的<code>React.Component</code>替换为<code>React.PureComponent</code>，结果与上面一样吗？如果不一样，为什么？</li>
<li>如果我修改这一行代码<code>&lt;Test onClick=&#123;this.handleTestClick&#125; /&gt;</code>为<code>&lt;Test onClick=&#123;() =&gt; &#123;&#125;&#125; /&gt;</code>结果又如何？</li>
</ol>
<h2 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate"></a>shouldComponentUpdate</h2><p>好像所有的内容都要从这个东西说起，<code>shouldComponentUpdate</code>作为<code>React</code>生命周期的一部分，大多数<code>React</code>开发者至少还是听说过它的，简单来说在这个函数中返回一个布尔值，<code>React</code>会根据这个布尔值来判断组件是否需要重新渲染。</p>
<p><code>shouldComponentUpdate</code>接收两个参数，一个是更新后的<code>props</code>，一个是更新后的<code>state</code>，可以通过比较两个<code>props</code>和<code>state</code>来决定是否需要重新渲染组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Test componentDidUpdate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 每次点击 click 都会打印 Test componentDidUpdate</span></span><br><span class="line">  <span class="comment">// 添加这个函数后当 count 没有变化时不会打印 Test componentDidUpdate</span></span><br><span class="line">  <span class="title function_">shouldComponentUpdate</span>(<span class="params">nextProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">count</span> === nextProps.<span class="property">count</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">count</span>: <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">count</span>: state.<span class="property">count</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Test</span> <span class="attr">count</span>=<span class="string">&#123;this.state.count&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码也算比较直观的说明了<code>shouldComponentUpdate</code>的用法，为什么要这么做？当只有一个<code>Test</code>组件的时候可能影响不大，那如果有一千个乃至一万个<code>Test</code>的时候呢，每点击一次<code>click</code>就有一千个、一万个<code>Test</code>的<code>componentDidUpdate</code>被调用，这就有点夸张了。所以当你在使用循环渲染组件的时候就一定要注意到这一个点，它可能会成为你应用的瓶颈。</p>
<p>现在我们来解一下第一个问题，每次点击<code>click</code>的时候，<code>Test</code>组件会打印<code>Test componentDidUpdate</code>吗？</p>
<p>是的，每次点击<code>click</code>的时候，<code>Test</code>组件会打印<code>Test componentDidUpdate</code>，除非我们在<code>Test</code>中定义了<code>shouldComponentUpdate</code>，同时返回了<code>false</code>阻止其重新渲染。</p>
<h2 id="PureComponent"><a href="#PureComponent" class="headerlink" title="PureComponent"></a>PureComponent</h2><p>关于<code>React</code>的这个 API，相信大家也没有那么陌生，根据官方文档的说法<code>Component</code>和<code>PureComponent</code>很相似，两者的区别在于<code>PureComponent</code>中实现了<code>shouldComponentUpdate</code>函数，这也是为什么我说要从<code>shouldComponentUpdate</code>说起。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span> &#123;</span><br><span class="line">  <span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Test componentDidUpdate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 错误的用法</span></span><br><span class="line">  <span class="title function_">shouldComponentUpdate</span>(<span class="params">nextProps</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">count</span> === nextProps.<span class="property">count</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你在<code>PureComponent</code>中又使用了<code>shouldComponentUpdate</code>你应该会得到这样一个警告，侧面也告诉我们<code>PureComponent</code>已经实现了<code>shouldComponentUpdate</code>这个函数了。</p>
<blockquote>
<p>Test has a method called shouldComponentUpdate(). shouldComponentUpdate should not be used when extending React.PureComponent. Please extend React.Component if shouldComponentUpdate is used.</p>
</blockquote>
<p>官网文档中说<code>PureComponent</code>中以浅层对比<code>props</code>和<code>state</code>的方式来实现了这个函数，也就是浅比较，那什么又是浅比较呢？可以简单的理解为<code>a === b</code>，这里面还是有一些说头的，不过不在本文探讨范围内，举两个例子，大家可以自行搜索理解。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> c = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> d = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a === b); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(c === d); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>在来看一段因为不当的代码导致的问题，大家一定要注意这部分的内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span> &#123;</span><br><span class="line">  <span class="comment">// 根据从 App 中传来的 animal 渲染组件</span></span><br><span class="line">  <span class="comment">// 在 App 中每次点击添加新的动物后, 这里还是原来的 dog</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Test: &#123;this.props.animal.join(&#x27;,&#x27;)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="comment">// 默认为一只狗</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">animal</span>: [<span class="string">&#x27;dog&#x27;</span>] &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每次点击把新的值添加进 animal 中</span></span><br><span class="line">  <span class="comment">// 此处有一个 Bug, 由于 animal.push 方法虽然更新了原来的数组</span></span><br><span class="line">  <span class="comment">// 但是他们还是一个数组(这个说法有些奇怪), 指针还是一样的</span></span><br><span class="line">  <span class="comment">// 可能需要读者自行搜索理解 JS 中基本类型和引用类型的存储方式</span></span><br><span class="line">  <span class="comment">// 所以当 Test 组件接收到新的 animal 时, 通过浅比较会发现它们其实是一样的</span></span><br><span class="line">  <span class="comment">// 也就意味着 Test 不会重新渲染</span></span><br><span class="line">  <span class="title function_">handleClick</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; animal &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    animal.<span class="title function_">push</span>(val)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      animal,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据 state 中的 animal 渲染组件</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>App: &#123;this.state.animal.join(&#x27;,&#x27;)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.handleClick(&#x27;cat&#x27;)&#125;&gt;click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Test</span> <span class="attr">animal</span>=<span class="string">&#123;this.state.animal&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里相信你应该能解答第二个问题和第三个问题了，不过我们还是一起再来看看~</p>
<p>问：如果我把<code>Test</code>组件的<code>React.Component</code>替换为<code>React.PureComponent</code>，结果与上面一样吗？如果不一样，为什么？</p>
<p>答：因为每次传递<code>props</code>中的<code>onClick</code>都是<code>App</code>组件中的<code>handleTestClick</code>，同时使用了<code>PureComponent</code>，所以每次浅比较都是一致的，所以不会在打印<code>Test componentDidUpdate</code>了。</p>
<p>问：如果我修改这一行代码<code>&lt;Test onClick=&#123;this.handleTestClick&#125; /&gt;</code>为<code>&lt;Test onClick=&#123;() =&gt; &#123;&#125;&#125; /&gt;</code>结果又如何？</p>
<p>答：虽然使用了<code>PureComponent</code>，但是由于<code>App</code>每次调用<code>render</code>函数的时候都会重新声明一个方法，此方法和上一次传递给<code>Test</code>的方法不同，所以每次点击还是会打印<code>Test componentDidUpdate</code>。</p>
<h2 id="剩点内容补充"><a href="#剩点内容补充" class="headerlink" title="剩点内容补充"></a>剩点内容补充</h2><p>除了上述两个 API 以外，其他 API 或多或少只是它们的改版，所以我就放在一起说了。</p>
<h3 id="memo"><a href="#memo" class="headerlink" title="memo"></a>memo</h3><p><code>React.memo</code>在我看来就是<code>PureComponent</code>无状态组件版本，如果用的是<code>class</code>就用<code>PureComponent</code>，如果用的是无状态组件就用<code>memo</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Test Component<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 它也可以接收第二个参数, 类似 shouldComponentUpdate</span></span><br><span class="line"><span class="comment">// 两个参数上次的props, 和当前的props</span></span><br><span class="line"><span class="comment">// 不传默认情况它们两个做浅比较, 传了由你自己控制</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>此方法返回值与<code>shouldComponentUpdate</code>相反，返回值为<code>true</code>时不重新渲染组件。</p>
<h3 id="useCallback-和-useMemo"><a href="#useCallback-和-useMemo" class="headerlink" title="useCallback 和 useMemo"></a>useCallback 和 useMemo</h3><p>这两个 API 是<code>React Hook</code>的一部分，为什么要放在一起说呢？因为它们非常的类似，据官方文档<code>useCallback(fn, deps)</code>相当于<code>useMemo(() =&gt; fn, deps)</code>。</p>
<p>因为<code>React Hook</code>，我现在基本很少写<code>class</code>组件了，原因是什么相信用过的小伙伴都清楚，本文不阐述这方面的内容，只想再问你一个问题：<code>handleClick</code>方法每次都会重新定义吗？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案是会的，不信你可以验证一下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Set</span></span><br><span class="line"><span class="keyword">let</span> set = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [val, setVal] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 对比两种方式可以看出区别</span></span><br><span class="line">  <span class="comment">// const handleClick = useCallback(() =&gt; console.log(&#x27;click&#x27;), []);</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;click&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// set 存的唯一值, 每次都会添加一个新值</span></span><br><span class="line">  set.<span class="title function_">add</span>(handleClick);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 如果 Test 是个特别复杂的组件, handleClick 每次变化都会导致它重新渲染 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Test</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">Test</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setVal(val + 1)&#125;&gt;click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用法和说明其实从上述的样例可以看出，就不在额外的说明了。有时候我们除了函数需要缓存以外，一个值可能也需要，这时候就需要使用<code>useMemo</code>，它们两的区别也在于此，直接看用法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> set = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [val, setVal] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 对比三种方式可以看出区别</span></span><br><span class="line">  <span class="comment">// const obj = useMemo(() =&gt; (&#123; label: &#x27;Test&#x27;, value: &#x27;test&#x27; &#125;),[]);</span></span><br><span class="line">  <span class="comment">// const obj = &#x27;obj&#x27;;</span></span><br><span class="line">  <span class="keyword">const</span> obj = &#123; <span class="attr">label</span>: <span class="string">&#x27;Test&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;test&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">  set.<span class="title function_">add</span>(obj);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(set.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 如果 Test 是个特别复杂的组件, obj 每次变化都会导致它重新渲染 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Test</span> <span class="attr">obj</span>=<span class="string">&#123;obj&#125;</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">Test</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setVal(val + 1)&#125;&gt;click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里面又涉及到一个<code>JavaScript</code>中基本类型和引用类型的区别，与上面浅比较类似，你可以试试当<code>obj</code>等于一个基本类型时候的效果。</p>
<h3 id="Profiler"><a href="#Profiler" class="headerlink" title="Profiler"></a>Profiler</h3><p>最后的最后我们来说一下<code>Profiler</code>，它是用来测量被其包裹的 DOM 树渲染所带来的开销，帮助你排查性能瓶颈，直接看用法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Profiler</span>, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">callback</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  id, <span class="comment">// 发生提交的 Profiler 树的 “id”</span></span></span><br><span class="line"><span class="params">  phase, <span class="comment">// &quot;mount&quot; （如果组件树刚加载） 或者 &quot;update&quot; （如果它重渲染了）之一</span></span></span><br><span class="line"><span class="params">  actualDuration, <span class="comment">// 本次更新 committed 花费的渲染时间</span></span></span><br><span class="line"><span class="params">  baseDuration, <span class="comment">// 估计不使用 memoization 的情况下渲染整颗子树需要的时间</span></span></span><br><span class="line"><span class="params">  startTime, <span class="comment">// 本次更新中 React 开始渲染的时间</span></span></span><br><span class="line"><span class="params">  commitTime, <span class="comment">// 本次更新中 React committed 的时间</span></span></span><br><span class="line"><span class="params">  interactions <span class="comment">// 属于本次更新的 interactions 的集合</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    id,</span><br><span class="line">    phase,</span><br><span class="line">    actualDuration,</span><br><span class="line">    baseDuration,</span><br><span class="line">    startTime,</span><br><span class="line">    commitTime,</span><br><span class="line">    interactions</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [val, setVal] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Profiler</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span> <span class="attr">onRender</span>=<span class="string">&#123;callback&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Test</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">Test</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Profiler</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setVal(val + 1)&#125;&gt;click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最后的最后"><a href="#最后的最后" class="headerlink" title="最后的最后"></a>最后的最后</h2><p>我所知道的<code>React</code>跟性能优化相关的 API 都在上面了，说实话我们遇到需要性能优化的场景真的太少了，这也是为什么面试官挑人的时候总喜欢问这方面的问题，因为大多数人都没有关注过，我们想要的也是那一小部分人。所以，多学点知识真的对自己很好，理解更多的内容，你才能更好的理解别人的代码。</p>
</article>
</div>
</div>
    </main>
    <footer class="absolute bottom-2 left-0 right-0">
  <div class="mx-auto max-w-3xl flex items-center justify-between">
    <p class="text-sm">
       Copyright &copy;  2023 青湛
    </p>
    <p class="text-sm">
      Powered by
      <a href="https://hexo.io" target="_blank" class="underline">Hexo</a>
      • Theme
      <a
        href="https://github.com/mintsweet/hexo-theme-mints"
        target="_blank"
        class="underline"
        >Mints</a
      >
    </p>
  </div>
</footer>

  </body>
</html>
